<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Souza Farma - Sistema de Bulas Profissional</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        .close-button { transition: all 0.2s; }
        .close-button:hover { transform: rotate(90deg); color: #ef4444; }
        .logo-container { max-width: 250px; margin: 0 auto; padding: 10px; background-color: #fff; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .intensity-btn.active { background-color: #4f46e5; color: white; border-color: #4338ca; box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.4); }
        .freq-highlight { background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border: 1px solid #bbf7d0; }
        .card-med { transition: all 0.2s; border-width: 2px; }
        .card-med:hover { transform: translateY(-3px); border-color: #6366f1; }
        .category-tag { font-size: 9px; padding: 2px 6px; border-radius: 4px; font-weight: 800; text-transform: uppercase; margin-bottom: 4px; display: inline-block; }
    </style>

    <script>
        window.allMedicamentos = [];
        const LOCAL_STORAGE_KEY = 'souzafarma_bulas_v4_final';

        // LISTA MESTRA CONSOLIDADA (MAIS DE 50 ITENS)
        const baseMedicamentos = [
            // --- ANTIBIÓTICOS E CLAVULANATOS ---
            { nome: "Amoxicilina 400mg/5mL", principioAtivo: "Amoxicilina Suspensão", dosagem: "400mg/5ml", categoria: "Antibiótico", tipoCalculo: "faixa", pesoBaseCalculo: { infoDoseRef: "(25 a 45 mg/kg/dia)", doseMgPerKgPerDiaMin: 25, doseMgPerKgPerDiaMax: 45, defaultDose: 30, freqDosesPorDia: 2, concentracaoMgPerMl: 80, freqTexto: "12/12h (2 vezes ao dia)." } },
            { nome: "Amoxicilina + Clavulanato 400+57mg/5mL", principioAtivo: "Amoxicilina + Clavulanato", dosagem: "400mg+57mg/5ml", categoria: "Antibiótico", tipoCalculo: "faixa", pesoBaseCalculo: { infoDoseRef: "(25 a 45 mg/kg/dia)", doseMgPerKgPerDiaMin: 25, doseMgPerKgPerDiaMax: 45, defaultDose: 30, freqDosesPorDia: 2, concentracaoMgPerMl: 80, freqTexto: "12/12h (2 vezes ao dia)." } },
            { nome: "Amoxicilina + Clavulanato 250+62,5mg/5mL", principioAtivo: "Amoxicilina + Clavulanato", dosagem: "250mg+62,5mg/5ml", categoria: "Antibiótico", tipoCalculo: "faixa", pesoBaseCalculo: { infoDoseRef: "(20 a 40 mg/kg/dia)", doseMgPerKgPerDiaMin: 20, doseMgPerKgPerDiaMax: 40, defaultDose: 30, freqDosesPorDia: 3, concentracaoMgPerMl: 50, freqTexto: "8/8h (3 vezes ao dia)." } },
            { nome: "Amoxicilina 250mg/5mL", principioAtivo: "Amoxicilina Suspensão", dosagem: "250mg/5ml", categoria: "Antibiótico", tipoCalculo: "faixa", pesoBaseCalculo: { infoDoseRef: "(20 a 50 mg/kg/dia)", doseMgPerKgPerDiaMin: 20, doseMgPerKgPerDiaMax: 50, defaultDose: 40, freqDosesPorDia: 3, concentracaoMgPerMl: 50, freqTexto: "8/8h (3 vezes ao dia)." } },
            { nome: "Azitromicina 200mg/5mL", principioAtivo: "Azitromicina", dosagem: "200mg/5ml", categoria: "Antibiótico", tipoCalculo: "faixa", pesoBaseCalculo: { infoDoseRef: "(10 mg/kg/dia)", doseMgPerKgPerDiaMin: 10, doseMgPerKgPerDiaMax: 10, defaultDose: 10, freqDosesPorDia: 1, concentracaoMgPerMl: 40, freqTexto: "Dose Única Diária (24/24h)." } },
            { nome: "Cefadroxila 250mg/5mL", principioAtivo: "Cefadroxila Suspensão", dosagem: "250mg/5mL", categoria: "Antibiótico", tipoCalculo: "faixa", pesoBaseCalculo: { infoDoseRef: "(30 a 50 mg/kg/dia)", doseMgPerKgPerDiaMin: 30, doseMgPerKgPerDiaMax: 50, defaultDose: 30, freqDosesPorDia: 2, concentracaoMgPerMl: 50, freqTexto: "12/12h (2 vezes ao dia)." } },
            { nome: "Cefalexina 250mg/5mL", principioAtivo: "Cefalexina", dosagem: "250mg/5mL", categoria: "Antibiótico", tipoCalculo: "faixa", pesoBaseCalculo: { infoDoseRef: "(25 a 50 mg/kg/dia)", doseMgPerKgPerDiaMin: 25, doseMgPerKgPerDiaMax: 50, defaultDose: 30, freqDosesPorDia: 4, concentracaoMgPerMl: 50, freqTexto: "6/6h (4 vezes ao dia)." } },

            // --- ANTIPARASITÁRIOS ---
            { nome: "Nitazoxanida (Annita) Suspensão", principioAtivo: "Nitazoxanida 20mg/mL", dosagem: "20 mg/mL", categoria: "Antiparasitário", tipoCalculo: "faixa", pesoBaseCalculo: { infoDoseRef: "(15 mg/kg/dia)", doseMgPerKgPerDiaMin: 15, doseMgPerKgPerDiaMax: 15, defaultDose: 15, freqDosesPorDia: 2, concentracaoMgPerMl: 20, freqTexto: "12/12h por 3 dias (0,375 mL/kg por dose)." } },
            { nome: "Annita Comprimido 500mg", principioAtivo: "Nitazoxanida", dosagem: "500 mg", categoria: "Antiparasitário", posologia: "Adultos: 1 comprimido 12/12h por 3 dias." },
            { nome: "Ivermectina 6mg", principioAtivo: "Ivermectina", dosagem: "6 mg", categoria: "Antiparasitário", tipoCalculo: "faixa", pesoBaseCalculo: { infoDoseRef: "(0.2 mg/kg única)", doseMgPerKgPerDiaMin: 0.2, doseMgPerKgPerDiaMax: 0.2, defaultDose: 0.2, freqDosesPorDia: 1, concentracaoMgPerMl: 6, freqTexto: "Dose única." } },

            // --- RESPIRATÓRIO ---
            { nome: "Acebrofilina Xarope 25mg/5mL", principioAtivo: "Acebrofilina (Ped)", dosagem: "25 mg / 5 mL", categoria: "Expectorante", tipoCalculo: "faixa", pesoBaseCalculo: { infoDoseRef: "(4 mg/kg/dia)", doseMgPerKgPerDiaMin: 4, doseMgPerKgPerDiaMax: 4, defaultDose: 4, freqDosesPorDia: 2, concentracaoMgPerMl: 5, freqTexto: "12/12h (2 vezes ao dia)." } },
            { nome: "Acebrofilina Xarope 50mg/5mL", principioAtivo: "Acebrofilina (Adulto)", dosagem: "50 mg / 5 mL", categoria: "Expectorante", posologia: "Adultos: 10mL a cada 12 horas." },
            { nome: "Acetilcisteína Xarope 20mg/mL", principioAtivo: "Acetilcisteína (Ped)", dosagem: "20 mg/mL", categoria: "Expectorante", tipoCalculo: "faixa", pesoBaseCalculo: { infoDoseRef: "(20 a 30 mg/kg/dia)", doseMgPerKgPerDiaMin: 20, doseMgPerKgPerDiaMax: 30, defaultDose: 20, freqDosesPorDia: 3, concentracaoMgPerMl: 20, freqTexto: "8/8h ou 12/12h conforme indicação." } },
            { nome: "Acetilcisteína Xarope 40mg/mL", principioAtivo: "Acetilcisteína (Adulto)", dosagem: "40 mg/mL", categoria: "Expectorante", posologia: "Adultos: 15mL (1 copo) 1 vez ao dia." },
            { nome: "Dropropizina 1,5mg/mL Xarope", principioAtivo: "Dropropizina (Ped)", dosagem: "1,5 mg/mL", categoria: "Antitussígeno", tipoCalculo: "faixa", pesoBaseCalculo: { infoDoseRef: "(1 a 2 mg/kg/dia)", doseMgPerKgPerDiaMin: 1, doseMgPerKgPerDiaMax: 2, defaultDose: 1.5, freqDosesPorDia: 3, concentracaoMgPerMl: 1.5, freqTexto: "8/8h (3 vezes ao dia)." } },
            { nome: "Dropropizina 3mg/mL Xarope", principioAtivo: "Dropropizina (Adulto)", dosagem: "3 mg/mL", categoria: "Antitussígeno", posologia: "Adultos: 10mL até 4 vezes ao dia." },

            // --- CORTICOIDES ---
            { nome: "Predsim® Solução 3 mg/mL", principioAtivo: "Prednisolona", dosagem: "3 mg/mL (Pipeta)", categoria: "Corticosteroide", tipoCalculo: "intensidade", pesoBaseCalculo: { infoDoseRef: "(0,14 a 2 mg/kg/dia)", temIntensidade: true, intensidades: [{ label: "Manutenção", valor: 0.5, obs: "(0.5 mg/kg)" }, { label: "Intermediária", valor: 1.0, obs: "(1.0 mg/kg)" }, { label: "Ataque", valor: 2.0, obs: "(2.0 mg/kg)" }], currentIntensidade: 0.5, freqDosesPorDia: 1, concentracaoMgPerMl: 3, unidade: "mL", maxDoseDiariaMg: 60, restricaoIdade: "Usar pipeta graduada.", freqTexto: "Dose total diária conforme orientação." } },
            { nome: "Predsim Gotas 11 mg/mL", principioAtivo: "Prednisolona", dosagem: "11 mg/mL", categoria: "Corticosteroide", tipoCalculo: "intensidade", pesoBaseCalculo: { infoDoseRef: "(0,14 a 2 mg/kg/dia)", temIntensidade: true, intensidades: [{ label: "Manutenção", valor: 0.5, obs: "(0.5 mg/kg)" }, { label: "Intermediária", valor: 1.0, obs: "(1.0 mg/kg)" }, { label: "Ataque", valor: 2.0, obs: "(2.0 mg/kg)" }], currentIntensidade: 0.5, concentracaoMgPerMl: 11, unidade: "Gotas", maxDoseDiaria: 145, freqTexto: "Administrar conforme orientação médica." } },

            // --- ANTI-HISTAMÍNICOS ---
            { nome: "Fexofenadina (Allegra) Suspensão", principioAtivo: "Fexofenadina 6mg/mL", dosagem: "6 mg/mL", categoria: "Anti-histamínico", tipoCalculo: "faixa", pesoBaseCalculo: { infoDoseRef: "(2 a 5 mg/kg/dia)", doseMgPerKgPerDiaMin: 2, doseMgPerKgPerDiaMax: 5, defaultDose: 2, freqDosesPorDia: 2, concentracaoMgPerMl: 6, freqTexto: "12/12h conforme orientação médica." } },
            { nome: "Hidroxizina Suspensão", principioAtivo: "Hixizine", dosagem: "2 mg/mL", categoria: "Anti-histamínico", tipoCalculo: "faixa", pesoBaseCalculo: { infoDoseRef: "(2 mg/kg/dia)", doseMgPerKgPerDiaMin: 2, doseMgPerKgPerDiaMax: 2, defaultDose: 2, freqDosesPorDia: 3, concentracaoMgPerMl: 2, freqTexto: "8/8h (3 vezes ao dia)." } },
            { nome: "Dexclorfeniramina Suspensão", principioAtivo: "Polaramine", dosagem: "0,4 mg/mL", categoria: "Anti-histamínico", tipoCalculo: "faixa", pesoBaseCalculo: { infoDoseRef: "(0,15 mg/kg/dia)", doseMgPerKgPerDiaMin: 0.15, doseMgPerKgPerDiaMax: 0.15, defaultDose: 0.15, freqDosesPorDia: 3, concentracaoMgPerMl: 0.4, freqTexto: "8/8h ou 6/6h." } },

            // --- ANALGÉSICOS E ANTIESPASMÓDICOS ---
            { nome: "Dipirona 500mg/mL Gotas", principioAtivo: "Dipirona", dosagem: "500 mg/mL", categoria: "Analgésico", tipoCalculo: "tabelaDipirona", pesoBaseCalculo: { infoDoseRef: "(8 a 16 mg/kg/dose)", maxDoseDiaria: 160, freqTexto: "Até 4 vezes ao dia (6/6h)." } },
            { nome: "Ibuprofeno 100mg/mL Gotas", principioAtivo: "Ibuprofeno", dosagem: "100 mg/mL", categoria: "Analgésico", tipoCalculo: "intensidade", pesoBaseCalculo: { infoDoseRef: "(5 a 10 mg/kg/dose)", temIntensidade: true, intensidades: [{ label: "Leve", valor: 5, obs: "(5 mg/kg)" }, { label: "Intensa", valor: 10, obs: "(10 mg/kg)" }], currentIntensidade: 5, concentracaoMgPerMl: 100, unidade: "Gotas", maxDosePorTomada: 20, maxDoseDiaria: 80, freqTexto: "A cada 6 ou 8 horas." } },
            { nome: "Buscopan® Gotas (Simples)", principioAtivo: "Escopolamina", dosagem: "10 mg/mL", categoria: "Antiespasmódico", tipoCalculo: "tabelaBuscopan", pesoBaseCalculo: { infoDoseRef: "(0,3 a 1,5 mg/kg/dose)", freqTexto: "3 vezes ao dia (8/8h)." } },
            { nome: "Bromoprida Gotas", principioAtivo: "Digesan", dosagem: "4 mg/mL", categoria: "Antiemético", tipoCalculo: "intensidade", pesoBaseCalculo: { infoDoseRef: "(1 gota/kg/dose)", currentIntensidade: 0.2, concentracaoMgPerMl: 4, unidade: "Gotas", maxDosePorTomada: 40, freqDosesPorDia: 3, freqTexto: "3 vezes ao dia (a cada 8 horas)." } },

            // --- OUTROS ---
            { nome: "Decongex Plus Gotas", principioAtivo: "Bronfeniramina + Fenilefrina", dosagem: "2 mg + 2,5 mg/mL", categoria: "Descongestionante", tipoCalculo: "tabelaDecongexGotas", pesoBaseCalculo: { maxDoseDiariaGotas: 60, freqTexto: "Administrar 3 vezes ao dia (8/8h)." } },
            { nome: "Luftal (Simeticona) Gotas", principioAtivo: "Simeticona", dosagem: "75 mg/mL", categoria: "Antigases", posologia: "Lactentes: 3-5 Gotas. Crianças: 5-10 Gotas." },
            { nome: "Dramin B6 Gotas", principioAtivo: "Dimenidrinato", dosagem: "Gotas", categoria: "Antiemético", posologia: "1 gota por kg de peso corporal por dose." }
        ];

        const initApp = async () => {
            const saved = localStorage.getItem(LOCAL_STORAGE_KEY);
            let userList = saved ? JSON.parse(saved) : [];
            window.allMedicamentos = [...baseMedicamentos];
            userList.forEach(uMed => {
                if(!window.allMedicamentos.find(m => m.nome === uMed.nome)) window.allMedicamentos.push(uMed);
            });
            searchMedicamentos('');
            document.getElementById('loading-overlay').classList.add('hidden');
        };

        window.searchMedicamentos = (term) => {
            const searchTerm = term.toLowerCase().trim();
            const results = window.allMedicamentos.filter(med => 
                med.nome.toLowerCase().includes(searchTerm) ||
                med.principioAtivo.toLowerCase().includes(searchTerm) ||
                med.categoria?.toLowerCase().includes(searchTerm)
            );
            displayResults(results);
        };

        const displayResults = (results) => {
            const resultsDiv = document.getElementById('search-results');
            resultsDiv.innerHTML = results.length ? '' : `<p class="text-center text-gray-500 py-12 col-span-full">Nenhum medicamento encontrado.</p>`;
            results.forEach((med) => {
                const color = getCategoryColor(med.categoria);
                const item = document.createElement('div');
                item.className = 'card-med p-4 bg-white border border-gray-200 rounded-2xl shadow-sm hover:shadow-md cursor-pointer flex flex-col justify-between';
                item.onclick = () => showBulaDetails(med);
                item.innerHTML = `
                    <div>
                        <span class="category-tag" style="background-color: ${color}20; color: ${color}">${med.categoria || 'Geral'}</span>
                        <h3 class="text-md font-bold text-gray-800 leading-tight mt-1">${med.nome}</h3>
                        <p class="text-[11px] text-gray-400 mt-1 line-clamp-1 italic">${med.principioAtivo}</p>
                    </div>
                    <div class="mt-4 flex justify-between items-center border-t pt-3">
                        <span class="text-[10px] font-medium text-gray-400">${med.dosagem}</span>
                        <span class="text-indigo-600 font-bold text-xs">Cacular &rarr;</span>
                    </div>
                `;
                resultsDiv.appendChild(item);
            });
        };

        const getCategoryColor = (cat) => {
            const colors = { 'Antibiótico': '#ef4444', 'Analgésico': '#3b82f6', 'Corticosteroide': '#f59e0b', 'Anti-histamínico': '#8b5cf6', 'Expectorante': '#10b981', 'Antiparasitário': '#6366f1' };
            return colors[cat] || '#64748b';
        };

        window.showBulaDetails = (med) => {
            const modal = document.getElementById('bula-modal');
            const content = document.getElementById('bula-content');
            content.innerHTML = `
                <div class="mb-6 text-left">
                    <span class="bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-wider">${med.categoria || 'Medicamento'}</span>
                    <h2 class="text-2xl font-black text-gray-900 mt-2">${med.nome}</h2>
                    <p class="text-gray-500 font-medium text-sm">${med.principioAtivo} | ${med.dosagem}</p>
                </div>
                <div id="dose-calculator-container"></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6 text-left">
                    <div class="bg-gray-50 p-4 rounded-xl border border-gray-100">
                        <h3 class="font-bold text-xs text-gray-700 mb-2 flex items-center gap-2 uppercase tracking-tighter">Indicações</h3>
                        <p class="text-xs text-gray-600 leading-relaxed">${med.indicacoes || 'Consultar bula oficial.'}</p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-xl border border-gray-100">
                        <h3 class="font-bold text-xs text-gray-700 mb-2 flex items-center gap-2 uppercase tracking-tighter">Observações</h3>
                        <p class="text-xs text-gray-600 leading-relaxed">${med.reacoesAdversas || 'Verificar bula para efeitos colaterais.'}</p>
                    </div>
                </div>
            `;
            setupCalculator(med, false); 
            modal.classList.remove('hidden');
        };

        const setupCalculator = (med, forceWeightFill = false) => {
            const container = document.getElementById('dose-calculator-container');
            const p = med.pesoBaseCalculo;
            if(!p) {
                container.innerHTML = `<div class="bg-indigo-50 p-5 rounded-2xl border border-indigo-100 text-left"><h3 class="text-indigo-800 font-bold mb-2 text-sm uppercase">Posologia Sugerida</h3><p class="text-gray-700 font-bold text-lg">${med.posologia || 'Dose sob orientação médica.'}</p></div>`;
                return;
            }

            let selectionHtml = "";
            if (p.temIntensidade) {
                selectionHtml = `<div class="mb-4 text-left"><label class="block text-xs font-bold text-gray-500 uppercase mb-2">Opção de Dosagem</label><div class="grid grid-cols-1 sm:grid-cols-3 gap-2">${p.intensidades.map(int => `<button onclick="changeIntensity('${med.nome}', ${int.valor})" class="intensity-btn px-4 py-3 text-xs border rounded-xl transition-all font-semibold text-center ${p.currentIntensidade === int.valor ? 'active' : 'bg-white text-gray-600 border-gray-200'}">${int.label}<br><span class="opacity-70 font-normal">${int.obs}</span></button>`).join('')}</div></div>`;
            } else if (p.doseMgPerKgPerDiaMin && p.doseMgPerKgPerDiaMin !== p.doseMgPerKgPerDiaMax) {
                selectionHtml = `<div class="mb-4 text-left"><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Dose Alvo (mg/kg/dia): <span id="dose-val" class="font-bold text-indigo-600">${p.defaultDose}</span></label><input type="range" id="dose-slider" min="${p.doseMgPerKgPerDiaMin}" max="${p.doseMgPerKgPerDiaMax}" value="${p.defaultDose}" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-indigo-600" oninput="runCalculation('${med.nome}')"></div>`;
            }

            container.innerHTML = `
                <div class="bg-indigo-50 p-5 rounded-2xl border border-indigo-100 shadow-inner text-left">
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-1">
                            <label class="block text-xs font-bold text-gray-500 uppercase">Peso do Paciente (kg)</label>
                            <span class="text-[10px] font-black text-indigo-500 uppercase tracking-tighter">${p.infoDoseRef || ''}</span>
                        </div>
                        <input type="number" id="peso-input" step="0.1" placeholder="Ex: 12" class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none text-xl font-black" oninput="runCalculation('${med.nome}')">
                    </div>
                    ${selectionHtml}
                    <div id="result-area" class="grid grid-cols-2 gap-3 mb-4">
                        <div id="result-box" class="bg-indigo-600 text-white p-4 rounded-xl text-center shadow-lg"><p class="text-[9px] uppercase font-bold opacity-80 tracking-widest">Dose Única</p><p id="result-dose" class="text-2xl font-black">---</p></div>
                        <div id="daily-box" class="bg-indigo-900 text-white p-4 rounded-xl text-center shadow-lg"><p class="text-[9px] uppercase font-bold opacity-80 tracking-widest">Total Diário</p><p id="result-daily" class="text-2xl font-black">---</p></div>
                    </div>
                    <div class="mb-4 freq-highlight p-4 rounded-xl flex items-start gap-3 shadow-sm text-left">
                        <div class="bg-green-500 p-2 rounded-lg text-white"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></div>
                        <div><p class="text-[9px] uppercase font-bold text-green-700 tracking-widest">Frequência e Horários</p><p id="freq-text-display" class="text-sm font-extrabold text-green-900 leading-tight">${p.freqTexto}</p></div>
                    </div>
                    <div id="warning-area">
                        <p id="warning-text" class="text-xs font-bold text-orange-600 mb-2 hidden text-left">⚠️ Atenção: Limite máximo atingido!</p>
                        <div class="text-[11px] text-gray-500 bg-white p-3 rounded-lg border border-indigo-100 text-left">
                            <p id="age-hint" class="font-bold text-indigo-700 mb-1"></p>
                            <p class="font-medium text-red-600 flex items-center gap-1"><svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>${p.restricaoIdade || 'Consultar orientação médica.'}</p>
                        </div>
                    </div>
                </div>
            `;
            if(forceWeightFill && window.lastWeight) { document.getElementById('peso-input').value = window.lastWeight; runCalculation(med.nome); }
        };

        window.runCalculation = (medNome) => {
            const med = window.allMedicamentos.find(m => m.nome === medNome);
            const peso = parseFloat(document.getElementById('peso-input').value);
            window.lastWeight = peso;
            const p = med.pesoBaseCalculo;
            
            const doseEl = document.getElementById('result-dose');
            const dailyEl = document.getElementById('result-daily');
            const hintEl = document.getElementById('age-hint');
            const warningEl = document.getElementById('warning-text');
            const resultBox = document.getElementById('result-box');

            if (!peso || peso <= 0) {
                doseEl.innerText = "---"; dailyEl.innerText = "---"; if(hintEl) hintEl.innerText = "";
                return;
            }

            let dUnica = "---"; let dTotal = "---"; let hint = ""; let warn = false;
            const formatValue = (val, unit) => `(${Number(val.toFixed(2)).toString().replace('.', ',')} ${unit})`;

            if (med.tipoCalculo === "tabelaDecongexGotas") {
                let total = Math.min(peso * 2, 60);
                dUnica = formatValue(Math.round(total/3), "Gotas"); dTotal = formatValue(total, "Gotas");
                if(total >= 60) warn = true;
            }
            else if (med.tipoCalculo === "tabelaDecongex") {
                if(peso < 12) { dUnica = "N/A"; hint = "Contraindicado < 2 anos"; }
                else if(peso < 35) { dUnica = formatValue(5, "mL"); dTotal = formatValue(20, "mL"); hint = "Crianças (>2 anos)"; }
                else { dUnica = formatValue(15, "mL"); dTotal = formatValue(60, "mL"); hint = "Adultos/Adolescentes"; }
            }
            else if (med.nome.includes("Solução 3 mg/mL") || med.nome.includes("Solução 3mg/mL")) {
                let mgKg = p.currentIntensidade; let mgT = Math.min(peso * mgKg, 60);
                dUnica = formatValue(mgT/3, "mL"); dTotal = formatValue(mgT/3, "mL");
                if(peso * mgKg >= 60) warn = true;
            }
            else if (med.nome.includes("Predsim Gotas 11 mg/mL")) {
                let mgKg = p.currentIntensidade; let gtt = Math.min(Math.round((peso * mgKg)/0.55), 145);
                dUnica = formatValue(gtt, "Gotas"); dTotal = formatValue(145, "Gotas");
                if(Math.round((peso*mgKg)/0.55) >= 145) warn = true;
            }
            else if (med.tipoCalculo === "tabelaBuscopanComposto") {
                let gtt = peso < 10 ? 0 : Math.min(Math.round(peso * 0.5), 40);
                dUnica = gtt > 0 ? formatValue(gtt, "Gotas") : "N/A"; dTotal = gtt > 0 ? formatValue(gtt * 3, "Gotas") : "---";
            }
            else if (med.tipoCalculo === "tabelaBuscopan") {
                let gtt = 0;
                if(peso < 6) gtt = Math.round(peso*3); else if(peso < 10) gtt = Math.round(peso*1.4); else gtt = Math.min(Math.round(peso), 40);
                dUnica = formatValue(gtt, "Gotas"); dTotal = formatValue(gtt * 3, "Gotas");
            }
            else if (med.tipoCalculo === "tabelaDipirona") {
                let g = peso < 5 ? 0 : (peso <= 8 ? 5 : (peso <= 15 ? 10 : (peso <= 23 ? 15 : (peso <= 30 ? 20 : (peso <= 45 ? 30 : (peso <= 53 ? 35 : 40))))));
                dUnica = g > 0 ? formatValue(g, "Gotas") : "N/A"; dTotal = g > 0 ? formatValue(g*4, "Gotas") : "---";
            }
            else if (med.tipoCalculo === "intensidade") {
                let mgKg = p.currentIntensidade;
                let gtt = Math.round((peso * mgKg) / (p.concentracaoMgPerMl/20));
                if(p.maxDosePorTomada && gtt > p.maxDosePorTomada) { gtt = p.maxDosePorTomada; warn = true; }
                dUnica = formatValue(gtt, "Gotas"); 
                dTotal = formatValue(gtt * (p.freqDosesPorDia || 4), "Gotas");
            }
            else if (p.doseMgPerKgPerDiaMin) {
                let mk = parseFloat(document.getElementById('dose-slider')?.value || p.defaultDose);
                let ml = (peso * mk / p.freqDosesPorDia) / p.concentracaoMgPerMl;
                dUnica = formatValue(ml, "mL"); dTotal = formatValue(ml * p.freqDosesPorDia, "mL");
                if(document.getElementById('dose-val')) document.getElementById('dose-val').innerText = mk;
            }

            doseEl.innerText = dUnica; dailyEl.innerText = dTotal; hintEl.innerText = hint;
            if(warn) { warningEl.classList.remove('hidden'); resultBox.classList.replace('bg-indigo-600', 'bg-orange-500'); }
            else { warningEl.classList.add('hidden'); resultBox.classList.replace('bg-orange-500', 'bg-indigo-600'); }
        };

        window.changeIntensity = (nome, valor) => {
            const med = window.allMedicamentos.find(m => m.nome === nome);
            med.pesoBaseCalculo.currentIntensidade = valor;
            setupCalculator(med, true);
        };

        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</head>
<body class="min-h-screen pb-12 text-center">
    <div id="loading-overlay" class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center">
        <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-indigo-500"></div>
        <p class="mt-4 text-indigo-600 font-bold">SOUZA FARMA</p>
    </div>

    <div class="max-w-6xl mx-auto p-4 md:p-8">
        <header class="mb-10">
            <div class="logo-container">
                <img src="souza_farma_logo.png" alt="Souza Farma" class="w-full h-auto" onerror="this.src='https://placehold.co/300x100?text=Souza+Farma'">
            </div>
            <h1 class="text-4xl font-black text-indigo-700 mt-4 tracking-tighter">Bulas & Calculadora</h1>
            <p class="text-gray-500 text-xs mt-1 uppercase tracking-[0.3em] font-black">Apoio Profissional v3.7</p>
        </header>

        <div class="max-w-2xl mx-auto mb-10">
            <div class="relative group">
                <input type="text" placeholder="Qual medicamento procura?" oninput="searchMedicamentos(this.value)" 
                    class="w-full pl-14 pr-6 py-5 bg-white border-2 border-gray-100 rounded-3xl shadow-xl focus:ring-4 focus:ring-indigo-50/50 focus:border-indigo-500 outline-none transition-all text-lg font-bold">
                <div class="absolute left-5 top-5 text-gray-300 group-focus-within:text-indigo-500 transition-colors">
                    <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                </div>
            </div>
        </div>

        <div id="search-results" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"></div>
    </div>

    <div id="bula-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-80 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-[2.5rem] p-6 md:p-10 w-full max-w-3xl max-h-[92vh] overflow-y-auto relative shadow-2xl border border-white text-center">
            <button onclick="closeModal('bula-modal')" class="close-button absolute top-8 right-8 text-4xl text-gray-300 hover:text-red-500 transition-colors">&times;</button>
            <div id="bula-content"></div>
        </div>
    </div>
</body>
</html>
